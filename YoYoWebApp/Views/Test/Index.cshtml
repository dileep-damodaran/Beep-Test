<!DOCTYPE html>
<html lang="en">
<head>
    <title>YoYoWebApp</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/Static/Styles/app.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    @*<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>*@
</head>
<body>



    @*<div class="row">
        <div class="col-sm-12 text-center">*@
            <!--<button id="" class="btn btn-primary btn-md center-block horizontal-block" Style="width: 100px;" OnClick="btnSearch_Click">Warn</button>
            <button id="" class="btn btn-danger btn-md center-block horizontal-block" Style="width: 100px;" OnClick="btnClear_Click">Stop</button>-->
        @*</div>
    </div>*@





    <div class="jumbotron text-center">
        <div class="row text-center">
            <div class="col-sm-12">
                <h3>BEEP TEST</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <button class="btn-start" id="session-start">Start</button>
                <button class="btn-end" id="session-end" style="display:none">Stop</button>
                <div class="" id="level_board">
                    <p id="level" class="time">Level :</p>
                    <p id="shuttle" class="time">Shuttle</p>
                </div>
            </div>
        </div>
        <div class="container text-center">
            <div class="row">
                <div class="col-sm-12">
                    <div class="col-sm-4" style="border-bottom-color:black">
                        <h4>NEXT SHUTTLE</h4>
                        <p id="next_shuttle" class="time">0:0</p>
                    </div>
                    <div class="col-sm-4" style="border-bottom-color:black;">
                        <h4>TOTAL TIME</h4>
                        <span id="total_time_minute" class="time">00</span>
                        <span id="total_time_second" class="time">00</span>
                        @*<span id="total_time_millisecond" class="time">000</span>*@

                    </div>
                    <div class="col-sm-4" style="border-bottom-color:black">
                        <h4>TOTAL DISTANCE</h4>
                        <p id="total_distance" class="time">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="athele_board">

    </div>

</body>
</html>


<script type="text/javascript">

    function WarnAthlete(athleteId) {
        $.ajax({
            url: `/Test/WarnAthlete?id=${athleteId}`,
            type: "POST",
            success: function (result) {

                var msg = `Athlete ${athleteId} warned successfully.`;
                console.log(msg);
            },
            error: function (error) {
                console.log(error);
            }
        });
    };

    function StopAthlete(athleteId) {
        $.ajax({
            url: `/Test/StopAthlete?id=${athleteId}`,
            type: "POST",
            success: function (result) {

                var msg = `Athlete ${athleteId} Stopped successfully.`;
                console.log(msg);
            },
            error: function (error) {
                console.log(error);
            }
        });
    };

    $(document).ready(function () {

        $(document).on('click', '#session-end', function (event) {

            Stop();
            var comp = $("#session-end");
            comp.text('Completed');
            comp.prop('id', '');
            comp.prop('class', 'btn-start');
        });

        $("#session-start").click(function () {
            debugger;
            Start();
            var comp = $("#session-start");
            comp.hide();
            $("#session-end").show();
        });

        function Start() {

            var getWebSocketMessages = function (onMessageReceived) {

                var url = `wss://${location.host}/Test/Start`;

                var webSocket = new WebSocket(url);

                webSocket.onmessage = onMessageReceived;
            };

            var nextShuttle = document.getElementById('next_shuttle');
            var totalTimeMinute = document.getElementById('total_time_minute');
            var totalTimeSecond = document.getElementById('total_time_second');
            var totalTimeMilliSecond = document.getElementById('total_time_millisecond');
            var toatlDistance = document.getElementById('total_distance');

            var level = document.getElementById('level');
            var shuttle = document.getElementById('shuttle');


            getWebSocketMessages(function (message) {

                var data = JSON.parse(message.data);

                console.log(`data.IsCompleted  = ${data.IsCompleted}`);
                if (data.IsCompleted === true)
                    return;

                nextShuttle.innerHTML = `${data.NextShuttle.Minute} : ${data.NextShuttle.Second}`;
                totalTimeMinute.innerHTML = `${data.TotalTime.Minute} :`;
                totalTimeSecond.innerHTML = `${data.TotalTime.Second}`;
                toatlDistance.innerHTML = `${data.TotalDistance}`;
                level.innerHTML = `${data.Level}`;
                shuttle.innerHTML = `${data.Shuttle}`;

                for (var i = 0; i < data.Athletes.length; i++) {

                    var athlete = data.Athletes[i];

                    var warnButton = $(`#warn-${athlete.Id}`);
                    var stopButton = $(`#stop-${athlete.Id}`);
                    var state = $(`#state-${athlete.Id}`);

                    if (athlete.State === 1) {
                        //RUNNING
                        state.text('Running');
                        warnButton.show();
                        warnButton.text('Warn');
                        warnButton.prop("disabled", false);
                        warnButton.prop('class', 'btn btn-warning');

                        stopButton.show();
                        stopButton.text('Stop');
                        stopButton.prop("disabled", false);
                        stopButton.prop('class', 'btn btn-danger');
                    }
                    else if (athlete.State === 2) {
                        //WARNED
                        state.text('Warned');
                        warnButton.text('Warned');
                        warnButton.prop('disabled', true);

                        stopButton.text('Stop');
                        stopButton.show();
                        stopButton.prop('class', 'btn btn-danger');
                    }
                    else if (athlete.State === 3) {

                    }
                    else if (athlete.State === 4) {
                        //FINISHED
                        state.text('Completed');
                        warnButton.fadeOut();
                        stopButton.fadeOut();
                    }
                    else if (athlete.State === 5) {
                        //STOPPED
                        state.text('Stopped');
                        warnButton.fadeOut();
                        stopButton.fadeOut();
                    }


                    if (athlete.Result != null) {

                        console.log(athlete.Result);
                        var resultTab = $(`#result-${athlete.Id}`);
                        var result = `Level : ${athlete.Result.SpeedLevel} , Shuttle : ${athlete.Result.ShuttleNo}`;
                        resultTab.text(result);
                    }
                }
            });
        };

        function Stop() {
            $.ajax({
                url: "/Test/Stop",
                type: "POST",
                success: function (result) {
                    console.log('Test completed successfully.');
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        function BuildAthleteRowHtml(athlete) {

            var nameStrip = `<div id="name-${athlete.id}" class="btn btn-md center-block horizontal-block" Style="width: 100px;">${athlete.name}</div>`;
            var buttonStrip = GetButtonStrip(athlete);
            var stateStrip = `<div id="state-${athlete.id}" class="btn btn-md center-block horizontal-block" Style="width: 100px;"></div>`;

            var resultStrip = `<div id="result-${athlete.id}" class="btn btn-md center-block horizontal-block" Style="width: 100px;"></div>`;

            var rawhtml = '<div class="col-sm-12 user" style="background-color:aliceblue;">' + nameStrip + buttonStrip + stateStrip + resultStrip +'</div>';

            return rawhtml;
        }

        function GetButtonStrip(athlete) {

            var buttonstrip = '';

            switch (athlete.state) {
                case 0:
                    buttonstrip = `<button type="button" id="warn-${athlete.id}" class="btn btn-warning btn-md center-block horizontal-block" Style="width: 100px;" onclick="WarnAthlete(${athlete.id})"></button><button type="button" id="stop-${athlete.id}" class="btn btn-danger btn-md center-block horizontal-block" Style="width: 100px;" onclick="StopAthlete(${athlete.id})"></button>`;
                    break;

                default:
                    buttonstrip = '';
                    break;
            }

            return buttonstrip;
        }


        $.ajax({
            url: "/Test/GetAthletes",
            type: "GET",
            success: function (result) {
                var athleleBoard = document.getElementById('athele_board');
                for (var i = 0; i < result.length; i++) {
                    athleleBoard.innerHTML = athleleBoard.innerHTML += BuildAthleteRowHtml(result[i])
                }
            },
            error: function (error) {
                console.log(error);
            }
        });
    });
</script>